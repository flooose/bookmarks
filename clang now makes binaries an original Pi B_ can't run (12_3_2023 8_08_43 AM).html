<!DOCTYPE html> <html lang=en><!--
 Page saved with SingleFile 
 url: https://rachelbythebay.com/w/2023/11/30/armv6/ 
 saved date: Sun Dec 03 2023 08:08:43 GMT-0500 (Eastern Standard Time)
--><meta charset=utf-8>
<title>clang now makes binaries an original Pi B+ can't run</title>
<style>body{background-color:#eeeeee;font-family:verdana,arial,helvetica,sans-serif;color:#000000;max-width:600px;margin-left:auto;margin-right:auto;padding:0 10px 0 10px}.post{padding:10px 5px 5px 10px;background:#ffffff;overflow:auto;line-height:1.3}.post h2{font-size:1em}.header{-webkit-border-top-left-radius:15px;-webkit-border-top-right-radius:15px;-moz-border-radius-topleft:15px;-moz-border-radius-topright:15px;border-top-left-radius:15px;border-top-right-radius:15px;padding:1px 5px 5px 5px;background:#80d0f0}.header a{text-decoration:none}.date{text-align:right;background:#dddddd;padding:2px 2px 2px 2px;font-size:90%}.footer{-webkit-border-bottom-right-radius:15px;-webkit-border-bottom-left-radius:15px;-moz-border-radius-bottomright:15px;-moz-border-radius-bottomleft:15px;border-bottom-right-radius:15px;border-bottom-left-radius:15px;padding:5px 5px 5px 5px;background:#80d0f0;text-align:center}img{padding:1px;border:1px solid #021a40}.terminal{background-color:#f0f0f0;border-style:double;padding:1em;max-width:fit-content;overflow-x:auto}</style>
<link rel=alternate type=application/atom+xml href=https://rachelbythebay.com/w/atom.xml>
<meta name=viewport content="width=device-width, initial-scale=1">
<meta name=referrer content=no-referrer><link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAD/hAAAgmUAAP///wBeSQAAqoQAADsuAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQUFBQUFBQUFBQUFBQUFBQMDBQMDAwUDAwMFAwMDBQMDAwMDAwMDAwMDAwMDAwMDAQMBAQEDAQEBAwEBAQMBAQEBAQEBAQEBAQEBAQEBAQEEBAQBBAQEAQQEBAEEBAQBBAQEBAQEBAQEBAQEBAQEBAAABAAAAAQAAAAEAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAACAgIAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAgICAAAAAAACAgICAAAAAgICAgIAAAACAgICAgIAAAACAgICAgAAAAICAgIAAAAAAAICAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="><link rel=canonical href=https://rachelbythebay.com/w/2023/11/30/armv6/><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body>
<div class=header>
<h1><a href=https://rachelbythebay.com/w/>Writing</a></h1>
<p>
<a href=https://rachelbythebay.com/w/feed/><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJDSURBVHjajJJNSBRhGMd/887MzrQxRSLbFuYhoUhEKsMo8paHUKFLdBDrUIdunvq4RdClOq8Hb0FBSAVCUhFR1CGD/MrIJYqs1kLUXd382N356plZFOrUO/MMz/vO83+e93n+f+1zF+kQBoOQNLBJg0CTj7z/rvWjGbEOIwKp9O7WkhtQc/wMWrlIkP8Kc1lMS8eyFHpkpo5SgWCCVO7Z5JARhuz1Qg29fh87u6/9VWL1/SPc4Qy6n8c0FehiXin6dcCQaylDMhqGz8ydS2hKkmxNkWxowWnuBLHK6G2C8X6UJkBlxUmNqLYyNbzF74QLDrgFgh9LLE0NsPKxjW1Hz2EdPIubsOFdH2HgbwAlC4S19dT13o+3pS+vcSfvUcq9YnbwA6muW9hNpym/FWBxfh0CZkKGkPBZeJFhcWQAu6EN52QGZ/8prEKW+cdXq0039UiLXhUYzdjebOJQQI30UXp6mZn+Dtam32Afu0iyrgUvN0r+ZQbr8HncSpUVJfwRhBWC0hyGV8CxXBL5SWYf9sYBidYLIG2V87/ifVjTWAX6AlxeK2C0X8e58hOr/Qa2XJ3iLMWxB1h72tHs7bgryzHAN2o2gJorTrLxRHVazd0o4TXiyV2Yjs90uzauGvvppmqcLjwmbZ3V7BO2HOrBnbgrQRqWUgTZ5+Snx4WeKfzCCrmb3axODKNH+vvUyWjqyK4DiKQ0eXSpFsgVvLJQWpH+xSpr4otg/HI0TR/t97cxTUS+QxIMRTLi/9ZYJPI/AgwAoc3W7ZrqR2IAAAAASUVORK5CYII=" width=14 height=14 alt=Feed style=float:right;border-style:none></a>
Software, technology, sysadmin war stories, and more.</p>
</div>
<div class=date>
Thursday, November 30, 2023</div>
<div class=post>
<h2>clang now makes binaries an original Pi B+ can't run</h2>
<p>
I have a bunch of Raspberry Pi systems all over the place, goofy things 
that they are. They do dumb and annoying jobs in strange locations. I 
even have one of the older models, which is called just the B+. You can 
think of it as the "1B+" but apparently it was never officially branded 
the 1.
</p>
<p>
If you have one of these, or perhaps an original Pi Zero hanging around, 
you might find that C++ programs built with clang don't work any more.
I ran into this as soon as I started trying to take binaries from my 
"build host" (a much faster Pi 4B) to run them on this original beast. 
It throws an illegal instruction.
</p>
<p>
This used to work in the old version (bullseye). It now breaks in the 
current one (bookworm). I figured, okay, maybe it's doing some 
optimization because it was built on the 4B. So, I went and did a build 
on the B+ natively. It also broke.
</p>
<p>
So I backed off another level to a much simpler reproduction case: just 
declare main() and return. That still broke.
</p>
<p>
Looking this up, there are a bunch of screwy dead-end forum posts where 
people go back and forth asserting this package is installed and that's 
making the compiler go stupid, or it's because they did the "lite" 
install vs. the "recommended" install, or who knows what.
</p>
<p>
I wanted to do better than that, so this afternoon I picked up a brand 
new SD card, blew the whole "desktop + recommended" OS image onto it, 
booted *that*, then installed clang, and...
</p>
<pre class=terminal>raspberrypi:~/prog$ cat t.cc
#include &lt;stdio.h&gt;

int main() {
  return 0;
}
raspberrypi:~/prog$ clang++ -Wall -o t t.cc
raspberrypi:~/prog$ ./t
Illegal instruction
</pre>
<p>
Awesome. It can compile something it can't even run. What's the bad 
instruction? gdb will answer that in a jiffy.
</p>
<pre class=terminal>(gdb) disassemble
Dump of assembler code for function main:
   0x004005a4 &lt;+0&gt;:	sub	sp, sp, #4
=&gt; 0x004005a8 &lt;+4&gt;:	movw	r0, #0
</pre>
<p>
movw. That's not in armv6l, apparently. So yeah, this compiler is 
effectively cross-compiling for armv7 (or something) by default. That's 
not very useful.
</p>
<p>
You can work around this by grabbing the compiler by the lapels and 
saying "build for armv6, punk", and it will give you a working binary:
</p>
<pre class=terminal>raspberrypi:~/prog$ clang++ --target=armv6-unknown-linux-gnueabihf -Wall -o t t.cc
raspberrypi:~/prog$ ./t
raspberrypi:~/prog$ 
</pre>
<p>
How and why did it get to that point? I can only imagine it's some 
default that got bumped from version 11 to version 12, and somehow 
nobody noticed? I guess nobody still runs these old things anywhere?
</p>
<p>
So weird.
</p>
</div>
<div class=footer>
<a href=https://rachelbythebay.com/w/>More writing</a>
 | <a href=https://rachelbythebay.com/contact/>Contact / send feedback</a>
</div>
